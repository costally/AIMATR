<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon AI Coach v4.0</title>
    <style>
        :root {
            --primary: #007AFF;
            --primary-dark: #0056b3;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --info: #64D2FF; 
            --steady: #AF52DE;
            --fartlek: #FF2D55; 
            --cross: #FF9F0A; 
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text-main: #111111;
            --text-sub: #666666;
            --info-bg: #EEF1F5;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 800px; background-color: var(--card); border-radius: 24px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); padding: 30px; box-sizing: border-box; position: relative; overflow: hidden; min-height: 1100px; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        header { text-align: center; margin-bottom: 30px; }
        .badge { background-color: #E5E5EA; color: #555; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.5px; }
        h1 { margin: 12px 0 6px 0; font-size: 2rem; letter-spacing: -0.5px; color: #000; }
        .subtitle { font-size: 1rem; color: var(--text-sub); margin: 0; }

        /* Form Styles */
        .form-section { margin-bottom: 30px; border-bottom: 2px solid #f2f2f7; padding-bottom: 25px; }
        .form-section:last-of-type { border-bottom: none; }
        .section-title { font-size: 1rem; font-weight: 800; color: var(--primary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.95rem; color: #333; }
        select, input[type="date"] { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1.05rem; font-weight: 500; background: #fff; box-sizing: border-box; -webkit-appearance: none; transition: 0.2s; color: #000; }
        select:focus, input:focus { outline: none; border-color: var(--primary); background-color: #F8FBFF; }
        .time-picker-group { display: flex; gap: 8px; align-items: center; }
        .time-select-wrapper { flex: 1; position: relative; }
        .time-select-wrapper select { text-align: center; padding-right: 25px; font-weight: 600; }
        .time-label { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.85rem; color: #888; pointer-events: none; font-weight: 600; }

        .preset-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .preset-btn { flex: 1; padding: 14px 5px; border: 2px solid #e0e0e0; background: white; border-radius: 12px; font-size: 0.9rem; font-weight: 700; color: #555; cursor: pointer; transition: 0.2s; line-height: 1.3; position: relative; }
        .preset-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,122,255,0.2); }
        .preset-btn:hover:not(.active) { background: #f2f2f7; border-color: #ccc; }
        .rec-badge { position: absolute; top: -12px; right: -8px; background: #FF3B30; color: white; font-size: 0.7rem; padding: 4px 8px; border-radius: 20px; display: none; font-weight: 800; box-shadow: 0 3px 6px rgba(0,0,0,0.15); border: 2px solid #fff; animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10; }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }

        .feedback-box { background: #f2f2f7; padding: 18px; border-radius: 14px; margin-top: 15px; font-size: 0.95rem; display: flex; flex-direction: column; gap: 6px; border-left: 5px solid #ccc; transition: all 0.3s; }
        .feedback-box.safe { background: #e8fbf0; border-left-color: var(--success); color: #0c5122; }
        .feedback-box.challenge { background: #fff8e6; border-left-color: var(--warning); color: #7a4f01; }
        .feedback-box.danger { background: #feebeb; border-left-color: var(--danger); color: #c90a00; }
        .rec-time-display { font-size: 1.2rem; font-weight: 800; color: var(--primary-dark); margin-top: 5px; }

        .science-info { background-color: var(--info-bg); padding: 20px; border-radius: 14px; margin-top: 30px; font-size: 0.9rem; color: #444; line-height: 1.6; border: 1px solid #D1D5DB; }
        .science-info strong { color: #1c1c1e; font-weight: 800; display: block; margin-bottom: 8px; font-size: 0.95rem; }
        .science-info ul { margin: 5px 0 0 0; padding-left: 20px; }
        .science-info li { margin-bottom: 5px; }
        .fact-icon { margin-right: 6px; }

        button.cta { width: 100%; background-color: var(--primary); color: white; padding: 18px; border: none; border-radius: 16px; font-size: 1.15rem; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 6px 15px rgba(0,122,255,0.3); margin-top: 10px; }
        button.cta:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        button.secondary-btn { width: 100%; background-color: transparent; color: #8e8e93; padding: 14px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 15px; transition: color 0.2s; }
        button.secondary-btn:hover { color: #333; }

        /* Summary & Pace Grid */
        .summary-card { background: #F2F2F7; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; }
        .big-stat { font-size: 2.8rem; font-weight: 800; color: var(--primary); display: block; margin-bottom: 8px; letter-spacing: -1px; }
        .sub-stat { font-size: 1.1rem; color: #555; font-weight: 600; }
        .summary-info-row { display: flex; justify-content: center; gap: 20px; margin-top: 20px; color: #444; font-size: 0.95rem; font-weight: 500; }
        .pace-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-bottom: 35px; }
        .pace-card { background: white; padding: 15px; border-radius: 14px; border: 2px solid #e5e5ea; position: relative; text-align: center; transition: 0.3s; }
        .pace-card.highlight { border-color: var(--primary); box-shadow: 0 0 15px rgba(0,122,255,0.2); } /* í˜ì´ìŠ¤ ë³€ê²½ì‹œ ê°•ì¡° */
        .pace-label { font-size: 0.8rem; color: #777; font-weight: 700; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .pace-value { font-size: 1.1rem; font-weight: 800; color: #1c1c1e; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        .guide-list { margin-top: 30px; margin-bottom: 30px; }
        .guide-item { margin-bottom: 12px; background: white; border: 2px solid #E5E5EA; border-radius: 14px; padding: 15px; display: flex; flex-direction: column; }
        .guide-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .guide-title { font-weight: 800; font-size: 1.05rem; color: #222; }
        .guide-desc { font-size: 0.9rem; color: #555; line-height: 1.5; }
        .guide-tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; background: #F2F2F7; color: #555; font-weight: 700; margin-left: auto; }

        /* Daily Schedule UI */
        .daily-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .day-card { background: white; border: 2px solid #E5E5EA; border-radius: 18px; padding: 15px; position: relative; transition: all 0.2s; cursor: pointer; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .day-card.type-Rest { border-top: 6px solid #8e8e93; }
        .day-card.type-Easy { border-top: 6px solid var(--success); }
        .day-card.type-Speed { border-top: 6px solid var(--danger); }
        .day-card.type-Tempo { border-top: 6px solid var(--warning); }
        .day-card.type-Fartlek { border-top: 6px solid var(--fartlek); }
        .day-card.type-Long { border-top: 6px solid #333; }
        .day-card.type-Medium { border-top: 6px solid var(--steady); }
        .day-card.type-Recovery { border-top: 6px solid var(--info); }
        .day-card.type-Wed { border-top: 6px solid var(--cross); }

        .day-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: #ccc; }
        .day-card.active { border: 3px solid var(--primary); background-color: #F4F9FF; transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,122,255,0.2); z-index: 10; }
        
        /* Completed State */
        .day-card.completed { opacity: 0.6; background-color: #f9f9f9; border-color: #ddd; transform: none; }
        .day-card.completed::before { content: 'âœ…'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; opacity: 0.3; z-index: 0; }
        
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .day-date { font-size: 0.9rem; color: #666; font-weight: 700; }
        .day-badge { font-size: 0.65rem; font-weight: 800; padding: 3px 8px; border-radius: 6px; background: #eee; color: #555; text-transform: uppercase; }
        .today .day-badge { background: #1c1c1e; color: #fff; }

        .day-icon { font-size: 2.2rem; display: block; margin-bottom: 10px; text-align: center; }
        .day-title { font-size: 1.1rem; font-weight: 800; color: #222; margin-bottom: 6px; text-align: center; letter-spacing: -0.5px; }
        .day-desc { font-size: 0.85rem; color: #555; text-align: center; line-height: 1.4; height: 36px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-weight: 500; }

        /* Detail Box */
        .detail-box { background: white; border: 2px solid #E5E5EA; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: slideUp 0.3s ease-out; }
        .detail-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .detail-icon-box { width: 60px; height: 60px; background: #F2F2F7; border-radius: 16px; display: flex; justify-content: center; align-items: center; font-size: 2rem; }
        .detail-title-group h3 { margin: 0 0 5px 0; font-size: 1.6rem; color: #111; }
        .detail-title-group span { font-size: 1rem; color: #666; font-weight: 500; }
        .detail-content { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .info-block { background: #F9F9F9; padding: 20px; border-radius: 14px; border-left: 5px solid var(--primary); }
        .info-label { font-size: 0.95rem; font-weight: 900; color: var(--primary-dark); margin-bottom: 10px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-text { font-size: 1rem; color: #333; line-height: 1.7; }
        .caution-box { background: #FFF0F0; border-left: 5px solid var(--danger); padding: 20px; border-radius: 14px; }
        .caution-label { color: var(--danger); font-weight: 900; font-size: 0.9rem; margin-bottom: 5px; display: block; }
        
        /* Complete Button in Detail */
        .complete-btn { width: 100%; background: #34C759; color: white; padding: 15px; border: none; border-radius: 14px; font-size: 1.1rem; font-weight: 800; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3); transition: 0.2s; }
        .complete-btn:hover { background: #28a745; transform: scale(1.02); }
        .complete-btn.disabled { background: #ccc; cursor: default; box-shadow: none; transform: none; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .rpe-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; }
        .rpe-btn { background: #f2f2f7; border: 2px solid transparent; border-radius: 12px; padding: 10px 5px; cursor: pointer; transition: 0.2s; }
        .rpe-btn:hover { background: #e0e0e0; }
        .rpe-btn.selected { border-color: var(--primary); background: #F0F7FF; transform: translateY(-3px); }
        .rpe-emoji { font-size: 2rem; display: block; margin-bottom: 5px; }
        .rpe-label { font-size: 0.7rem; font-weight: 700; color: #555; }

        /* Toast */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); opacity: 0; transition: 0.3s; z-index: 2000; pointer-events: none; }
        .toast.show { opacity: 1; bottom: 40px; }

    </style>
</head>
<body>

    <div class="container">
        <!-- HEADER -->
        <header>
            <span class="badge">AI COACH v4.0</span>
            <h1>Marathon Planner</h1>
            <p class="subtitle" id="pageSubtitle">ë‚˜ë§Œì˜ ë§ì¶¤í˜• í›ˆë ¨ í”„ë¡œê·¸ë¨ ì„¤ì •</p>
        </header>

        <!-- [VIEW 1] ì…ë ¥ í™”ë©´ -->
        <div id="view-home" class="fade-in">
            <form id="runnerForm">
                <!-- Inputs kept same -->
                <div class="form-section">
                    <div class="section-title">1. Current Fitness (í˜„ì¬ ê¸°ëŸ‰)</div>
                    <div class="row">
                        <div class="col" style="flex: 0.8;"><label>ìµœê·¼ ë‹¬ë¦° ê±°ë¦¬</label><select id="currentDist" onchange="updateAll()"><option value="5">5km</option><option value="10" selected>10km</option><option value="21.0975">í•˜í”„</option><option value="42.195">í’€ì½”ìŠ¤</option></select></div>
                        <div class="col" style="flex: 1.2;"><label>ìµœê·¼ ê¸°ë¡</label><div class="time-picker-group"><div class="time-select-wrapper"><select id="curH" onchange="updateAll()"></select><span class="time-label">h</span></div><div class="time-select-wrapper"><select id="curM" onchange="updateAll()"></select><span class="time-label">m</span></div><div class="time-select-wrapper"><select id="curS" onchange="updateAll()"></select><span class="time-label">s</span></div></div></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="section-title">2. Target Goal (ëª©í‘œ ì„¤ì •)</div>
                    <div class="row" style="margin-bottom:15px;">
                        <div class="col" style="flex:0.8;"><label>ëª©í‘œ ëŒ€íšŒ</label><select id="targetDist" onchange="updateAll()"><option value="5">5K</option><option value="10">10K</option><option value="21.0975">í•˜í”„</option><option value="42.195" selected>í’€ì½”ìŠ¤</option></select></div>
                        <div class="col" style="flex:1.2;"><label>ëª©í‘œ ê¸°ë¡ ì„¤ì •</label><div class="time-picker-group"><div class="time-select-wrapper"><select id="tarH" onchange="updateAll()"></select><span class="time-label">h</span></div><div class="time-select-wrapper"><select id="tarM" onchange="updateAll()"></select><span class="time-label">m</span></div><div class="time-select-wrapper"><select id="tarS" onchange="updateAll()"></select><span class="time-label">s</span></div></div></div>
                    </div>
                    <label style="margin-top:25px;">í›ˆë ¨ ê¸°ê°„ ì„ íƒ</label>
                    <div class="preset-group"><button type="button" class="preset-btn" id="btn8" onclick="selectPreset(8, this)">8ì£¼</button><button type="button" class="preset-btn active" id="btn12" onclick="selectPreset(12, this)">12ì£¼</button><button type="button" class="preset-btn" id="btn16" onclick="selectPreset(16, this)">16ì£¼</button><button type="button" class="preset-btn" id="btnAuto" onclick="selectPreset('auto', this)">ëŒ€íšŒì¼ê¹Œì§€</button></div>
                    <div class="row" style="margin-bottom: 25px;">
                        <div class="col"><label>í›ˆë ¨ ì‹œì‘ì¼ (Start)</label><input type="date" id="startDate" onchange="updateAll()"></div>
                        <div class="col"><label>ëŒ€íšŒ ë‚ ì§œ (Race)</label><input type="date" id="raceDate" onchange="enableCustomMode()"></div>
                    </div>
                    <div id="goalFeedback" class="feedback-box"><span>ğŸ¯ ê¸°ë¡ì„ ì…ë ¥í•˜ë©´ AIê°€ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</span></div>
                </div>
                <div class="form-section"><div class="section-title">3. Schedule (í›ˆë ¨ ë¹ˆë„)</div><select id="freq" onchange="updateAll()"><option value="3">ì£¼ 3íšŒ (ìœ ì§€/ê±´ê°•)</option><option value="4" selected>ì£¼ 4íšŒ (ê¸°ë¡í–¥ìƒ ê¶Œì¥)</option><option value="5">ì£¼ 5íšŒ (ì—˜ë¦¬íŠ¸/Sub-3)</option></select></div>
                <button type="button" class="cta" onclick="generateAndGoToSummary()">í”„ë¡œê·¸ë¨ ìƒì„±í•˜ê¸°</button>
            </form>
        </div>

        <!-- [VIEW 2] ìš”ì•½ í™”ë©´ -->
        <div id="view-summary" class="hidden">
            <div class="summary-card">
                <span class="sub-stat" id="sumTitle">ëª©í‘œ ì„¤ì • ê¸°ë¡</span>
                <span class="big-stat" id="sumTargetTime">00:00:00</span>
                <div class="summary-info-row"><span><span class="badge" style="background:var(--primary); color:white;">VDOT <span id="sumVdot">00</span></span></span><span>í›ˆë ¨ê¸°ê°„: <b style="color:#222" id="sumWeeks">00ì£¼</b></span><span>ëŒ€íšŒê¹Œì§€: <b style="color:#222" id="sumDday">D-00</b></span></div>
            </div>
            <h4 class="section-title">ğŸƒ Training Paces & Types</h4>
            <div class="pace-grid">
                <!-- Paces injected via JS -->
                <div class="pace-card"><div class="pace-label"><div class="dot" style="background:#64D2FF"></div>Recovery</div><div class="pace-value" id="paceRecovery">-</div></div>
                <div class="pace-card"><div class="pace-label"><div class="dot" style="background:var(--success)"></div>Easy / LSD</div><div class="pace-value" id="paceEasy">-</div></div>
                <div class="pace-card"><div class="pace-label"><div class="dot" style="background:#AF52DE"></div>Steady</div><div class="pace-value" id="paceSteady">-</div></div>
                <div class="pace-card"><div class="pace-label"><div class="dot" style="background:var(--fartlek)"></div>Fartlek</div><div class="pace-value">ììœ  ë³€ì†</div></div>
                <div class="pace-card"><div class="pace-label"><div class="dot" style="background:var(--warning)"></div>Threshold</div><div class="pace-value" id="paceThreshold">-</div></div>
                <div class="pace-card"><div class="pace-label"><div class="dot" style="background:var(--danger)"></div>Interval</div><div class="pace-value" id="paceInterval">-</div></div>
            </div>
            <h4 class="section-title">ğŸ“š Training Glossary (í›ˆë ¨ ìš©ì–´ì§‘)</h4>
            <div class="guide-list">
                <div class="guide-item"><div class="guide-header"><span style="font-size:1.2rem;">ğŸ©¹</span><span class="guide-title">Recovery (íšŒë³µì£¼)</span><span class="guide-tag">Zone 1</span></div><div class="guide-desc">ê³ ê°•ë„ í›ˆë ¨ ë‹¤ìŒ ë‚ , ëª¸ì— ìŒ“ì¸ í”¼ë¡œë¥¼ ì œê±°í•˜ê¸° ìœ„í•´ <strong>ì•„ì£¼ ì²œì²œíˆ</strong> ë‹¬ë¦½ë‹ˆë‹¤.</div></div>
                <div class="guide-item"><div class="guide-header"><span style="font-size:1.2rem;">ğŸƒâ€â™‚ï¸</span><span class="guide-title">Easy Run (ì¡°ê¹…)</span><span class="guide-tag">Zone 2</span></div><div class="guide-desc">ëŒ€í™”ê°€ ê°€ëŠ¥í•œ í¸ì•ˆí•œ ì†ë„ì…ë‹ˆë‹¤. LSDëŠ” ì´ ì†ë„ë¡œ <strong>ì˜¤ë˜, ë©€ë¦¬</strong> ë‹¬ë¦¬ëŠ” í›ˆë ¨ì…ë‹ˆë‹¤.</div></div>
                <div class="guide-item"><div class="guide-header"><span style="font-size:1.2rem;">ğŸ</span><span class="guide-title">Steady Run (ì§€ì†ì£¼)</span><span class="guide-tag">Zone 3</span></div><div class="guide-desc">ì¡°ê¹…ë³´ë‹¤ ë¹ ë¥´ê³  ëŒ€íšŒ í˜ì´ìŠ¤ë³´ë‹¤ ì•½ê°„ ëŠë¦°, <strong>ê¸°ë¶„ ì¢‹ì€ ë¬µì§í•¨</strong>ì„ ìœ ì§€í•˜ë©° ë‹¬ë¦½ë‹ˆë‹¤.</div></div>
                <div class="guide-item"><div class="guide-header"><span style="font-size:1.2rem;">ğŸ’¨</span><span class="guide-title">Fartlek (íŒŒí‹€ë ‰)</span><span class="guide-tag">Zone 3-5</span></div><div class="guide-desc">"ìŠ¤í”¼ë“œ í”Œë ˆì´"ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤. ì •í•´ì§„ í˜•ì‹ ì—†ì´ ì§€í˜•ì§€ë¬¼ì´ë‚˜ ê¸°ë¶„ì— ë”°ë¼ ë¹ ë¥´ê²Œ ë‹¬ë ¸ë‹¤ê°€ ì²œì²œíˆ ë‹¬ë¦¬ê¸°ë¥¼ ë°˜ë³µí•©ë‹ˆë‹¤.</div></div>
                <div class="guide-item"><div class="guide-header"><span style="font-size:1.2rem;">ğŸ”¥</span><span class="guide-title">Threshold (ì—­ì¹˜ì£¼)</span><span class="guide-tag">Zone 4</span></div><div class="guide-desc">"í¸ì•ˆí•˜ê²Œ í˜ë“¤ë‹¤"ëŠ” ê°•ë„ì…ë‹ˆë‹¤. ì –ì‚°ì´ ìŒ“ì´ëŠ” ì‹œì ì„ ëŠ¦ì¶°ì£¼ì–´ ìŠ¤í”¼ë“œ ì§€êµ¬ë ¥ì„ ê¸°ë¦…ë‹ˆë‹¤.</div></div>
                <div class="guide-item"><div class="guide-header"><span style="font-size:1.2rem;">âš¡</span><span class="guide-title">Interval (ì¸í„°ë²Œ)</span><span class="guide-tag">Zone 5</span></div><div class="guide-desc">ìµœëŒ€ ì‹¬ë°•ìˆ˜ì— ë„ë‹¬í•˜ëŠ” ì§ˆì£¼ì™€ ë¶ˆì™„ì „ íœ´ì‹ì„ ë°˜ë³µí•©ë‹ˆë‹¤. ì—”ì§„(ì‹¬íê¸°ëŠ¥)ì˜ í¬ê¸°ë¥¼ í‚¤ìš°ëŠ” ê°€ì¥ ê°•ë ¥í•œ í›ˆë ¨ì…ë‹ˆë‹¤.</div></div>
            </div>
            <button type="button" class="cta" onclick="goToDetail()">ìƒì„¸ í›ˆë ¨ ë¡œë“œë§µ ë³´ê¸°</button>
            <button type="button" class="secondary-btn" onclick="goToHome()">ì¡°ê±´ ë‹¤ì‹œ ì„¤ì •í•˜ê¸°</button>
        </div>

        <!-- [VIEW 3] Roadmap í™”ë©´ -->
        <div id="view-detail" class="hidden">
            <div style="margin-bottom:25px;"><h3 style="margin:0;">ğŸ“… ì£¼ì°¨ë³„ í›ˆë ¨ ë¡œë“œë§µ</h3><p style="color:#666; font-size:0.95rem;">ì´ <span id="detailTotalWeeks">0</span>ì£¼ / <span id="detailTarget"></span> ëª©í‘œ</p></div>
            <div class="timeline-container" id="timelineArea"></div>
            <button type="button" class="cta" style="margin-top:20px;" onclick="goToSchedule()">ğŸ“† ì¼ìë³„ ìƒì„¸ ìŠ¤ì¼€ì¤„ ë³´ê¸°</button>
            <button type="button" class="secondary-btn" onclick="goToSummary()">â† ìš”ì•½ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <!-- [VIEW 4] Daily Schedule í™”ë©´ -->
        <div id="view-schedule" class="hidden">
            <h3 style="margin:0 0 15px 0;">ğŸ—“ï¸ ì£¼ê°„ í›ˆë ¨ ìŠ¤ì¼€ì¤„</h3>
            <div class="week-nav">
                <button class="nav-btn" onclick="changeWeek(-1)">â®</button>
                <div class="week-info"><span class="week-title" id="displayWeek">Week 1</span><span class="week-phase" id="displayPhase">Base Phase</span></div>
                <button class="nav-btn" onclick="changeWeek(1)">â¯</button>
            </div>
            <div class="daily-grid" id="dailyGrid"></div>
            
            <div id="detailBox" class="detail-box" style="display:none;">
                <div class="detail-header"><div class="detail-icon-box" id="dIcon"></div><div class="detail-title-group"><h3 id="dTitle"></h3><span id="dSubtitle"></span></div></div>
                <div class="detail-content">
                    <div class="info-block"><span class="info-label">ğŸ¯ WHY (ì˜¤ëŠ˜ì˜ ëª©í‘œ)</span><div class="info-text" id="dWhy"></div></div>
                    <div class="info-block"><span class="info-label">âš™ï¸ HOW (ìƒì„¸ í›ˆë ¨ ë£¨í‹´)</span><div class="info-text" id="dHow"></div></div>
                </div>
                <div class="caution-box"><span class="caution-label">âš ï¸ CAUTION (ì£¼ì˜ì‚¬í•­)</span><span id="dCaution"></span></div>
                
                <!-- Complete Button -->
                <button id="completeBtn" class="complete-btn" onclick="openFeedbackModal()">âœ… í›ˆë ¨ ì™„ë£Œ ì²´í¬</button>
            </div>
            <button type="button" class="secondary-btn" style="margin-top:30px;" onclick="goToDetail()">â† ë¡œë“œë§µìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0;">ì˜¤ëŠ˜ í›ˆë ¨ ì–´ë– ì…¨ë‚˜ìš”?</h3>
            <p style="color:#666; font-size:0.9rem;">ì†”ì§í•œ í”¼ë“œë°±ì´ AI ì½”ì¹­ì˜ ì •í™•ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.</p>
            
            <div class="rpe-grid">
                <div class="rpe-btn" onclick="selectRPE(1, this)"><span class="rpe-emoji">ğŸ˜</span><span class="rpe-label">ë„ˆë¬´ ì‰¬ì›€</span></div>
                <div class="rpe-btn" onclick="selectRPE(2, this)"><span class="rpe-emoji">ğŸ˜ƒ</span><span class="rpe-label">ì‰¬ì›€</span></div>
                <div class="rpe-btn" onclick="selectRPE(3, this)"><span class="rpe-emoji">ğŸ‘Œ</span><span class="rpe-label">ì ë‹¹í•¨</span></div>
                <div class="rpe-btn" onclick="selectRPE(4, this)"><span class="rpe-emoji">ğŸ¥µ</span><span class="rpe-label">í˜ë“¦</span></div>
                <div class="rpe-btn" onclick="selectRPE(5, this)"><span class="rpe-emoji">ğŸ¤®</span><span class="rpe-label">ë§¤ìš° í˜ë“¦</span></div>
            </div>

            <button class="cta" onclick="submitFeedback()">í”¼ë“œë°± ì œì¶œ</button>
            <button class="secondary-btn" onclick="closeFeedbackModal()" style="font-size:0.9rem; margin-top:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">ë©”ì‹œì§€</div>

    <script>
        let currentTrainingWeeks = 12; 
        let userPaces = {}; 
        let userFreq = 4;   
        let globalTargetDist = 42.195; 
        let currentViewWeek = 1;
        let globalStartDate = new Date(); 
        
        // v4.0 New Variables
        let paceAdjustmentFactor = 1.0; // 1.0 = 100% (Normal), >1.0 Slower, <1.0 Faster
        let completedWorkouts = {}; // Key: "W{week}-D{dayIndex}", Value: RPE score
        let selectedRPE = 0;
        let currentSelectedPlan = null; // To store which plan is currently viewed

        window.onload = function() { 
            initTimeSelects(); 
            document.getElementById('startDate').valueAsDate = new Date();
            const rd = new Date(); rd.setMonth(rd.getMonth()+3); 
            document.getElementById('raceDate').valueAsDate = rd;
            selectPreset(12, document.getElementById('btn12')); 
            updateAll(); 
        }

        // ... (Previous Functions: initTimeSelects, updateAll, getInputs, calculateRecommendation, updateRecommendationBadge, updateFeedbackBox, selectPreset, enableCustomMode, formatPace, secondsToTime, switchView, goToHome...) ...
        function initTimeSelects() {
            const createOpts = (el, max) => { for(let i=0; i<=max; i++) el.add(new Option(i, i)); };
            createOpts(document.getElementById('curH'), 9); createOpts(document.getElementById('curM'), 59); createOpts(document.getElementById('curS'), 59); 
            createOpts(document.getElementById('tarH'), 9); createOpts(document.getElementById('tarM'), 59); createOpts(document.getElementById('tarS'), 59);
        }
        function updateAll() { const i=getInputs(); if(i){ const r=calculateRecommendation(i); updateRecommendationBadge(r); updateFeedbackBox(i); } }
        
        function getInputs() {
            const curDist=parseFloat(document.getElementById('currentDist').value), curH=parseInt(document.getElementById('curH').value)||0, curM=parseInt(document.getElementById('curM').value)||0, curS=parseInt(document.getElementById('curS').value)||0;
            const curSec=(curH*3600)+(curM*60)+curS; if(curSec===0)return null;
            const targetDist=parseFloat(document.getElementById('targetDist').value), tarH=parseInt(document.getElementById('tarH').value)||0, tarM=parseInt(document.getElementById('tarM').value)||0, tarS=parseInt(document.getElementById('tarS').value)||0;
            const targetSec=(tarH*3600)+(tarM*60)+tarS; 
            const freq=parseInt(document.getElementById('freq').value)||4;
            return {curDist,curSec,targetDist,targetSec,freq};
        }

        function calculateRecommendation(d){
            const eq=d.curSec*Math.pow((d.targetDist/d.curDist),1.06); let fM=(d.freq===3)?0.8:(d.freq===5?1.2:1.0); const p=(w)=>eq*(1-(w*0.0025*fM));
            if(d.targetSec===0) return 12;
            if(p(8)<=d.targetSec*1.01)return 8; if(p(12)<=d.targetSec*1.01)return 12; return 16;
        }
        
        function updateRecommendationBadge(w){
            document.querySelectorAll('.rec-badge').forEach(b => { if(b && b.style) b.style.display='none'; });
            let btnId = w===8?"btn8":(w===12?"btn12":"btn16");
            const btn=document.getElementById(btnId); 
            if(btn){ const badge = btn.querySelector('.rec-badge'); if(badge) { badge.style.display='inline-block'; badge.innerText="AI ì¶”ì²œ"; } }
        }
        function updateFeedbackBox(d){
            const eqSec=d.curSec*Math.pow((d.targetDist/d.curDist),1.06); let fM=(d.freq===3)?0.8:(d.freq===5?1.2:1.0); const pSec=eqSec*(1-(currentTrainingWeeks*0.0025*fM));
            const ph=Math.floor(pSec/3600), pm=Math.floor((pSec%3600)/60), ps=Math.floor(pSec%60); const str=(ph>0?`${ph}ì‹œê°„ `:"")+`${pm}ë¶„ ${ps}ì´ˆ`;
            const box=document.getElementById('goalFeedback');
            if(d.targetSec===0){box.className="feedback-box";box.innerHTML=`<span>ğŸ¤– ëª©í‘œë¥¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ì…¨ë„¤ìš”.<br>í˜„ì¬ ê¸°ëŸ‰ ê¸°ì¤€ <strong>${currentTrainingWeeks}ì£¼</strong> í›ˆë ¨ ì‹œ ì˜ˆìƒ ê¸°ë¡:</span><div class="rec-time-display">${str}</div>`;return;}
            const diff=(pSec-d.targetSec)/pSec; let msg="",cls="feedback-box";
            if(diff<=-0.02){msg="ğŸ‘ ì¶©ë¶„í•©ë‹ˆë‹¤. ì—¬ìœ ë¡­ê²Œ ë‹¬ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.";cls+=" safe";}else if(diff<=0.015){msg="ğŸ‘Œ ì ì ˆí•©ë‹ˆë‹¤. ì„±ì‹¤íˆ í›ˆë ¨í•˜ë©´ ë‹¬ì„±ë©ë‹ˆë‹¤.";cls+=" safe";}else if(diff<=0.05){msg="ğŸ”¥ ë„ì „ì ì…ë‹ˆë‹¤. í›ˆë ¨ì„ ë¹ ì§€ë©´ í˜ë“­ë‹ˆë‹¤.";cls+=" challenge";}else{msg="âš ï¸ ë§¤ìš° ì–´ë µìŠµë‹ˆë‹¤. ëª©í‘œë¥¼ ë‚®ì¶”ê±°ë‚˜ ê¸°ê°„ì„ ëŠ˜ë¦¬ì„¸ìš”.";cls+=" danger";}
            box.className=cls; box.innerHTML=`<span>${msg}</span><div style="font-size:0.9rem; color:#555; margin-top:5px; padding-top:5px; border-top:1px solid rgba(0,0,0,0.1);">AI ì˜ˆìƒ: <strong>${str}</strong></div>`;
        }
        function selectPreset(w,b){
            document.querySelectorAll('.preset-btn').forEach(x=>x.classList.remove('active')); if(b)b.classList.add('active');
            const sVal = document.getElementById('startDate').value; const startD = sVal ? new Date(sVal) : new Date();
            if(w==='auto'){
                const v=document.getElementById('raceDate').value;
                if(!v){ const d=new Date(startD); d.setMonth(d.getMonth()+3); document.getElementById('raceDate').valueAsDate=d; currentTrainingWeeks=12; } 
                else { const raceD = new Date(v); const diff=Math.ceil((raceD - startD)/(86400000)); currentTrainingWeeks=Math.max(4, Math.floor(diff/7)); }
            } else { currentTrainingWeeks=w; const d=new Date(startD); d.setDate(d.getDate()+(w*7)); document.getElementById('raceDate').valueAsDate=d; }
            updateAll();
        }
        function enableCustomMode(){
            document.querySelectorAll('.preset-btn').forEach(x=>x.classList.remove('active')); document.getElementById('btnAuto').classList.add('active');
            const sVal = document.getElementById('startDate').value; const startD = sVal ? new Date(sVal) : new Date(); const v=document.getElementById('raceDate').value; 
            if(v){ const raceD = new Date(v); const diff=Math.ceil((raceD - startD)/86400000); currentTrainingWeeks=Math.max(1,Math.floor(diff/7)); updateAll(); }
        }
        function formatPace(s){const m=Math.floor(s/60),sc=Math.floor(s%60);return `${m}'${sc.toString().padStart(2,'0')}"`;}
        function secondsToTime(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=Math.floor(s%60);return (h>0?h+":":"")+m.toString().padStart(2,'0')+":"+sc.toString().padStart(2,'0');}

        function switchView(id){
            ['view-home','view-summary','view-detail','view-schedule'].forEach(v=>{document.getElementById(v).classList.add('hidden');document.getElementById(v).classList.remove('fade-in');});
            document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('fade-in');
            const sub = document.getElementById('pageSubtitle');
            if(id==='view-home') sub.innerText="ë‚˜ë§Œì˜ ë§ì¶¤í˜• í›ˆë ¨ í”„ë¡œê·¸ë¨ ì„¤ì •";
            else if(id==='view-summary') sub.innerText="ê³¼í•™ì  ë°ì´í„° ë¶„ì„ ê²°ê³¼";
            else if(id==='view-detail') sub.innerText="ë‹¨ê³„ë³„ í›ˆë ¨ ìŠ¤ì¼€ì¤„";
            else sub.innerText="ì¼ìë³„ ìƒì„¸ í›ˆë ¨ ê°€ì´ë“œ";
            window.scrollTo(0,0);
        }
        function goToHome(){switchView('view-home');} function goToSummary(){switchView('view-summary');} function goToDetail(){switchView('view-detail');} 
        function goToSchedule(){ currentViewWeek=1; switchView('view-schedule'); renderScheduleUI(); }

        // --- Generate Logic (Updated to reset adjustment) ---
        function generateAndGoToSummary() {
            let i = getInputs(); if(!i){alert("ì…ë ¥ í™•ì¸ í•„ìš”");return;}
            if(i.targetSec===0) {
                const eqSec = i.curSec * Math.pow((i.targetDist / i.curDist), 1.06);
                let fM = (i.freq===3)?0.8:(i.freq===5?1.2:1.0);
                i.targetSec = Math.floor(eqSec * (1 - (currentTrainingWeeks * 0.0025 * fM)));
                const h=Math.floor(i.targetSec/3600), m=Math.floor((i.targetSec%3600)/60), s=Math.floor(i.targetSec%60);
                document.getElementById('tarH').value=h; document.getElementById('tarM').value=m; document.getElementById('tarS').value=s;
                alert(`ëª©í‘œ ê¸°ë¡ì„ ìë™ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: ${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`);
            }

            const sVal = document.getElementById('startDate').value; globalStartDate = sVal ? new Date(sVal) : new Date();
            const rVal = document.getElementById('raceDate').value; const raceD = rVal ? new Date(rVal) : new Date();
            const diffDays = Math.ceil((raceD - globalStartDate)/86400000);
            if(diffDays <= 0) { alert("ëŒ€íšŒ ë‚ ì§œëŠ” ì‹œì‘ì¼ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤."); return; }
            
            const totalWeeks = Math.floor(diffDays / 7);
            userFreq = i.freq; globalTargetDist = i.targetDist;
            
            // Reset Adaptation
            paceAdjustmentFactor = 1.0;
            completedWorkouts = {};

            // Calculate Base Paces (Reference)
            const mp = i.targetSec/i.targetDist;
            userPaces = calculateUserPaces(mp, paceAdjustmentFactor);

            const vdot = (1000/((i.targetSec*Math.pow(10/i.targetDist,1.06))/60)*2.5).toFixed(1);
            
            document.getElementById('sumTitle').innerText = `${i.targetDist===42.195?'Full':(i.targetDist===21.0975?'Half':(i.targetDist===10?'10K':'5K'))} ëª©í‘œ`;
            document.getElementById('sumTargetTime').innerText = secondsToTime(i.targetSec);
            document.getElementById('sumVdot').innerText = vdot;
            document.getElementById('sumWeeks').innerText = `${totalWeeks}ì£¼`;
            document.getElementById('sumDday').innerText = `D-${diffDays}`;
            
            updatePaceCards(); // Render Paces

            renderTimeline(totalWeeks, i.freq, i.targetDist);
            document.getElementById('detailTotalWeeks').innerText = totalWeeks;
            document.getElementById('detailTarget').innerText = document.getElementById('sumTitle').innerText;
            
            goToSummary();
        }

        function calculateUserPaces(mp, factor) {
            // Factor > 1.0 means slower (Harder rpe -> slower pace)
            // Factor < 1.0 means faster
            const adjMp = mp * factor;
            return {
                recovery: formatPace(adjMp*1.35),
                easy: formatPace(adjMp*1.25),
                steady: formatPace(adjMp*1.10),
                marathon: formatPace(adjMp),
                threshold: formatPace(adjMp*0.93),
                interval: formatPace(adjMp*0.88),
                rawMp: adjMp // store raw for calc
            };
        }

        function updatePaceCards() {
            document.getElementById('paceRecovery').innerText = userPaces.recovery + "/km";
            document.getElementById('paceEasy').innerText = userPaces.easy + "/km";
            document.getElementById('paceSteady').innerText = userPaces.steady + "/km";
            document.getElementById('paceMarathon').innerText = userPaces.marathon + "/km";
            document.getElementById('paceThreshold').innerText = userPaces.threshold + "/km";
            document.getElementById('paceInterval').innerText = userPaces.interval + "/km";
        }

        // ... (renderTimeline, changeWeek, renderScheduleUI, getPhaseName same as before) ...
        function renderTimeline(weeks, freq, targetDist) {
            const container = document.getElementById('timelineArea'); container.innerHTML = "";
            let taper=2, peak=Math.max(2, Math.floor(weeks*0.25)), build=Math.max(3, Math.floor(weeks*0.35)), base=weeks-(taper+peak+build);
            if(base<1){base=1; build=weeks-(taper+peak+base);}
            const addCard = (type,name,dur,desc) => container.innerHTML += `<div class="phase-card ${type}"><div class="phase-header"><span class="phase-name">${name}</span><span class="phase-weeks">${dur}ì£¼ê°„</span></div><div class="phase-desc">${desc}</div></div>`;
            addCard('phase-base','1. Base',base,'ê¸°ì´ˆ ì²´ë ¥ ë° ìœ ì‚°ì†Œ ë² ì´ìŠ¤ êµ¬ì¶•'); addCard('phase-build','2. Build',build,'ë§ˆì¼ë¦¬ì§€ ì¦ê°€ ë° ì—­ì¹˜ í›ˆë ¨'); addCard('phase-peak','3. Peak',peak,'ìµœëŒ€ ê°•ë„, ì‹¤ì „ í˜ì´ìŠ¤ ì ì‘'); addCard('phase-taper','4. Taper',taper,'í›ˆë ¨ëŸ‰ ê°ì†Œ ë° ì»¨ë””ì…˜ ì¡°ì ˆ');
        }
        function changeWeek(d){ const n=currentViewWeek+d; if(n<1||n>currentTrainingWeeks)return; currentViewWeek=n; renderScheduleUI(); }
        function renderScheduleUI(){
            const p=getPhaseName(currentViewWeek, currentTrainingWeeks);
            document.getElementById('displayWeek').innerText=`Week ${currentViewWeek}`; document.getElementById('displayPhase').innerText=`${p} Phase`;
            renderDailyGrid(currentViewWeek);
        }
        function getPhaseName(w,t){
            let tp=2, pk=Math.max(2,Math.floor(t*0.25)), bd=Math.max(3,Math.floor(t*0.35)), bs=t-(tp+pk+bd);
            if(bs<1) bs=1;
            if(w<=bs) return "Base"; if(w<=bs+bd) return "Build"; if(w<=bs+bd+pk) return "Peak"; return "Taper";
        }

        // --- Schedule Rendering with Completed Status ---
        function renderDailyGrid(wNum){
            const grid=document.getElementById('dailyGrid'); grid.innerHTML="";
            const phase=getPhaseName(wNum,currentTrainingWeeks);
            const startDay = new Date(globalStartDate); startDay.setDate(globalStartDate.getDate() + (wNum-1)*7);
            const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            const plans=getWeeklyPlan(wNum,phase,userFreq,globalTargetDist);
            
            plans.forEach((p,i)=>{
                const d=new Date(startDay); d.setDate(startDay.getDate()+i);
                const dayName = days[d.getDay()]; const dStr=`${d.getMonth()+1}.${d.getDate()} (${dayName})`;
                const today = new Date();
                const isToday = (d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear());
                
                // Check if completed
                const id = `W${wNum}-D${i}`;
                const isDone = completedWorkouts[id] !== undefined;

                const card=document.createElement('div');
                card.className=`day-card type-${p.type} ${isToday?'today':''} ${isDone?'completed':''}`;
                card.onclick=(e)=>{
                    document.querySelectorAll('.day-card').forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); 
                    currentSelectedPlan = { ...p, id: id, date: dStr }; // Store current plan info
                    showDetail(p, isDone);
                };
                
                let badge = "";
                if(isToday) badge = `<span class="day-badge" style="background:#1c1c1e; color:#fff;">TODAY</span>`;
                else if(p.type==='Rest') badge = `<span class="day-badge">REST</span>`;

                card.innerHTML=`<div class="day-header"><div class="day-date">${dStr}</div>${badge}</div><span class="day-icon">${p.icon}</span><div class="day-title">${p.title}</div><div class="day-desc">${p.desc}</div>`;
                grid.appendChild(card);
            });
            if(grid.firstElementChild) { 
                grid.firstElementChild.classList.add('active'); 
                currentSelectedPlan = { ...plans[0], id: `W${wNum}-D0`, date: "Day 1" };
                showDetail(plans[0], completedWorkouts[`W${wNum}-D0`]); 
            }
        }

        function showDetail(p, isDone){
            document.getElementById('detailBox').style.display='block';
            document.getElementById('dIcon').innerText=p.icon; document.getElementById('dTitle').innerText=p.title; document.getElementById('dSubtitle').innerText=p.desc;
            document.getElementById('dWhy').innerText=p.why; document.getElementById('dHow').innerHTML=p.how; document.getElementById('dCaution').innerText=p.caution;
            
            // Button State
            const btn = document.getElementById('completeBtn');
            if(isDone) {
                btn.innerText = "âœ… í›ˆë ¨ ì™„ë£Œë¨ (í”¼ë“œë°± ì™„ë£Œ)";
                btn.classList.add('disabled');
                btn.onclick = null;
            } else {
                btn.innerText = "âœ… í›ˆë ¨ ì™„ë£Œ ë° í”¼ë“œë°±";
                btn.classList.remove('disabled');
                btn.onclick = openFeedbackModal;
            }
        }

        // --- FEEDBACK & ADAPTATION LOGIC ---
        function openFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'flex';
            selectedRPE = 0;
            document.querySelectorAll('.rpe-btn').forEach(b => b.classList.remove('selected'));
        }
        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
        }
        function selectRPE(val, el) {
            selectedRPE = val;
            document.querySelectorAll('.rpe-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }
        
        function submitFeedback() {
            if(selectedRPE === 0) { alert("ë‚œì´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            
            // 1. Save completion
            completedWorkouts[currentSelectedPlan.id] = selectedRPE;
            
            // 2. Logic for Adaptation
            // Hard workout (Speed, Interval, Tempo) logic vs Easy workout logic
            // But simple logic for MVP:
            // RPE 5 (Max effort) -> Reduce intensity (Slow down by 2%)
            // RPE 4 (Hard) -> Maintain or slight reduce if frequent
            // RPE 1-2 (Too Easy) -> Increase intensity (Speed up by 1%)
            
            let adjustmentMsg = "í›ˆë ¨ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
            let changed = false;

            if(selectedRPE === 5) {
                paceAdjustmentFactor *= 1.02; // Make paces 2% slower
                adjustmentMsg = "âš ï¸ í›ˆë ¨ì´ ë§¤ìš° í˜ë“œì…¨êµ°ìš”. ë‚¨ì€ ì¼ì •ì˜ í˜ì´ìŠ¤ë¥¼ í•˜í–¥ ì¡°ì •í•˜ì—¬ íšŒë³µì„ ë•ìŠµë‹ˆë‹¤.";
                changed = true;
            } else if(selectedRPE === 4) {
                // If easy run felt hard (4), adjust. If point run felt hard (4), it's okay.
                // For simplicity, slight adjustment
                paceAdjustmentFactor *= 1.01;
                adjustmentMsg = "ğŸ”¥ ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤! ë¬´ë¦¬í•˜ì§€ ì•Šë„ë¡ ê°•ë„ë¥¼ ì•„ì£¼ ì¡°ê¸ˆ ë‚®ì·„ìŠµë‹ˆë‹¤.";
                changed = true;
            } else if(selectedRPE === 1) {
                paceAdjustmentFactor *= 0.99; // Make paces 1% faster
                adjustmentMsg = "ğŸ’ª ì»¨ë””ì…˜ì´ ì¢‹ìœ¼ì‹œêµ°ìš”! í›ˆë ¨ ê°•ë„ë¥¼ ìƒí–¥ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.";
                changed = true;
            }

            // 3. Recalculate Paces globally
            if(changed) {
                userPaces = calculateUserPaces(userPaces.rawMp / (paceAdjustmentFactor/ (paceAdjustmentFactor/1.0 || 1)), paceAdjustmentFactor); 
                // Wait, rawMp is static base. 
                // Correction: rawMp needs to be preserved. 
                // Let's grab base MP from View 2 logic? Or simpler: store base MP.
                // Re-calling calculateUserPaces uses the *current* adjusted factor on the base.
                // NOTE: userPaces.rawMp tracks the *adjusted* base? No, let's fix this.
                // Easy fix: We apply factor to the *original* MP. But we lost original MP scope.
                // Let's just multiply current strings? No, parsing is hard.
                // Better: `userPaces` should be recalculated from scratch using `getInputs`.
                // Actually, `userPaces` is global. Let's recalculate based on Target Time which doesn't change.
                
                const inputs = getInputs();
                // Re-calc Target MP
                const eqSec = inputs.curSec * Math.pow((inputs.targetDist / inputs.curDist), 1.06);
                let fM = (inputs.freq===3)?0.8:(inputs.freq===5?1.2:1.0);
                const targetSec = Math.floor(eqSec * (1 - (currentTrainingWeeks * 0.0025 * fM)));
                const baseMp = targetSec / inputs.targetDist;
                
                userPaces = calculateUserPaces(baseMp, paceAdjustmentFactor);
                updatePaceCards(); // View 2 update
            }

            // 4. Close & Refresh
            closeFeedbackModal();
            showToast(adjustmentMsg);
            
            // Re-render grid to show "Completed" state and new paces in text
            renderDailyGrid(currentViewWeek);
            
            // Update detail view immediately
            const p = currentSelectedPlan; // It's reference might be old, but type/title ok. Desc needs update.
            // Actually getWeeklyPlan generates strings using `userPaces`. So re-rendering grid updates descriptions!
            // We just need to refresh the detail view text.
            // Find the plan again from the new grid generation?
            // Simpler: Just hide detail box or keep it open with updated "Done" button.
            // Let's hide it to force user to re-click if they want to see updated pace.
            // Or just update button state.
            const btn = document.getElementById('completeBtn');
            btn.innerText = "âœ… í›ˆë ¨ ì™„ë£Œë¨ (í”¼ë“œë°± ì™„ë£Œ)";
            btn.classList.add('disabled');
            btn.onclick = null;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ... (getWeeklyPlan same as v3.8.1) ...
        function getWeeklyPlan(week, phase, freq, distType) {
            const isFull = distType > 30; const isHalf = distType > 15 && distType < 30;
            let p = [
                { type: 'Easy', title: 'Easy Run', icon: 'ğŸƒâ€â™‚ï¸' },
                { type: 'Wed', title: 'ë³´ê°•/Easy', icon: 'ğŸ§˜' },
                { type: 'Speed', title: 'Point Run', icon: 'âš¡' },
                { type: 'Rest', title: 'íœ´ì‹', icon: 'ğŸ›Œ' },
                { type: 'Long', title: 'LSD', icon: 'ğŸ”ï¸' },
                { type: 'Recovery', title: 'Recovery', icon: 'ğŸ©¹' },
                { type: 'Rest', title: 'íœ´ì‹', icon: 'ğŸ›Œ' }
            ];
            
            if(freq === 3) { 
                p = [ { type: 'Easy', title: 'Easy Run', icon: 'ğŸƒâ€â™‚ï¸' }, { type: 'Rest', title: 'íœ´ì‹', icon: 'ğŸ›Œ' }, { type: 'Speed', title: 'Point Run', icon: 'âš¡' }, { type: 'Rest', title: 'íœ´ì‹', icon: 'ğŸ›Œ' }, { type: 'Long', title: 'LSD', icon: 'ğŸ”ï¸' }, { type: 'Rest', title: 'íœ´ì‹', icon: 'ğŸ›Œ' }, { type: 'Rest', title: 'íœ´ì‹', icon: 'ğŸ›Œ' } ];
            } else if(freq >= 5) { p[1] = {type:'Medium',title:'Steady Run',icon:'ğŸ'}; }

            let speedType = 'Tempo';
            if(phase === 'Base') speedType = 'Fartlek';
            else if(phase === 'Build') speedType = 'Tempo';
            else if(phase === 'Peak') speedType = 'Interval'; 
            else speedType = 'TaperPace';
            
            p.forEach(item => { if(item.type === 'Speed') item.type = speedType; });

            return p.map(d => {
                let desc="", tag="", why="", how="", caution="";
                if(d.type === 'Rest') { desc="ì™„ì „ íœ´ì‹"; tag="Recovery"; why="ê·¼ìœ¡ íšŒë³µ ë° ì„±ì¥ (ì´ˆê³¼ë³´ìƒ)"; how=`<ul><li>ì•„ë¬´ ìš´ë™ë„ í•˜ì§€ ì•Šê³  ì‰½ë‹ˆë‹¤.</li><li>ìˆ˜ë©´ ì‹œê°„ì„ í‰ì†Œë³´ë‹¤ 30ë¶„~1ì‹œê°„ ëŠ˜ë¦¬ì„¸ìš”.</li><li>ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ì´ë‚˜ í¼ë¡¤ëŸ¬ ë§ˆì‚¬ì§€ëŠ” ì¢‹ìŠµë‹ˆë‹¤.</li></ul>`; caution="ì£„ì±…ê° ê°–ì§€ ë§ê³  í‘¹ ì‰¬ì„¸ìš”."; }
                else if(d.type === 'Easy') { let dkm = isFull ? (phase==='Peak'?'10km':'8km') : '6km'; desc=`ì¡°ê¹… ${dkm} @ ${userPaces.easy}`; tag="Zone 2"; why="ìœ ì‚°ì†Œ ê¸°ì´ˆ ì²´ë ¥ í–¥ìƒ (ë¶€ìƒ ì—†ì´ ê±°ë¦¬ ëŠ˜ë¦¬ê¸°)"; how=`<ul><li><strong>ì›Œë°ì—…:</strong> 5ë¶„ ë¹ ë¥´ê²Œ ê±·ê¸°</li><li><strong>ë³¸ìš´ë™:</strong> ${dkm}ë¥¼ <strong>${userPaces.easy}</strong> í˜ì´ìŠ¤ë¡œ ë‹¬ë¦½ë‹ˆë‹¤.<br>ì˜† ì‚¬ëŒê³¼ í¸ì•ˆí•˜ê²Œ ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ì†ë„ì—¬ì•¼ í•©ë‹ˆë‹¤.</li><li><strong>ì¿¨ë‹¤ìš´:</strong> 5ë¶„ ì²œì²œíˆ ê±·ê¸°</li></ul>`; caution="ìˆ¨ì´ ì°¨ë©´ í˜ì´ìŠ¤ë¥¼ ë” ëŠ¦ì¶”ì„¸ìš”. ê±·ëŠ” ê²ƒë³´ë‹¤ ì•„ì£¼ ì¡°ê¸ˆ ë¹ ë¥¸ ì •ë„ë„ ê´œì°®ìŠµë‹ˆë‹¤."; }
                else if(d.type === 'Wed') { desc="ë³´ê°•ìš´ë™ 30ë¶„ or ì¡°ê¹… 5km"; tag="Cross"; why="ëŸ¬ë‹ì— í•„ìš”í•œ ì½”ì–´ ê·¼ìœ¡ ê°•í™” ë° ë¶€ìƒ ë°©ì§€"; how=`<ul><li><strong>ì˜µì…˜ A (ê·¼ë ¥):</strong> ìŠ¤ì¿¼íŠ¸ 15íšŒx3ì„¸íŠ¸, ëŸ°ì§€ 10íšŒx3ì„¸íŠ¸, í”Œë­í¬ 30ì´ˆx3ì„¸íŠ¸</li><li><strong>ì˜µì…˜ B (ëŸ¬ë‹):</strong> ëª¸ì´ ê°€ë³ë‹¤ë©´ <strong>${userPaces.easy}</strong>ë³´ë‹¤ ë” ëŠë¦¬ê²Œ 5km ì¡°ê¹…</li></ul>`; caution="ê·¼ìœ¡í†µì´ ì‹¬í•˜ë©´ ì˜µì…˜ A, B ëª¨ë‘ ê±´ë„ˆë›°ê³  ì‰¬ì„¸ìš”."; }
                else if(d.type === 'Medium') { let dkm = isFull ? (phase==='Peak'?'15km':'12km') : '10km'; desc=`ì§€ì†ì£¼ ${dkm} @ ${userPaces.steady}`; tag="Aerobic"; why="ì¤‘ìƒê¸‰ìë¥¼ ìœ„í•œ ì§€êµ¬ë ¥ ê°•í™”"; how=`<ul><li><strong>ì›Œë°ì—…:</strong> 1km ì•„ì£¼ ëŠë¦° ì¡°ê¹…</li><li><strong>ë³¸ìš´ë™:</strong> ${dkm}ë¥¼ <strong>${userPaces.steady}</strong> í˜ì´ìŠ¤ë¡œ ì¼ì •í•˜ê²Œ ë°‰ë‹ˆë‹¤.<br>ì¡°ê¹…ë³´ë‹¤ëŠ” ë¹ ë¥´ê³  í—‰í—‰ê±°ë¦´ ì •ë„ëŠ” ì•„ë‹Œ 'ë¬µì§í•œ' ëŠë‚Œì…ë‹ˆë‹¤.</li><li><strong>ì¿¨ë‹¤ìš´:</strong> 1km ê±·ê¸°</li></ul>`; caution="ì´ˆë°˜ì— ë„ˆë¬´ ë¹¨ë¦¬ ë‹¬ë¦¬ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”."; }
                else if(d.type === 'Fartlek') { d.title = "Fartlek"; d.icon = "ğŸ’¨"; desc = "ë³€ì†ì£¼ 40ë¶„"; tag = "Zone 3"; why="ìŠ¤í”¼ë“œì— ëŒ€í•œ ë‘ë ¤ì›€ì„ ì—†ì• ê³  ì‹¬íê¸°ëŠ¥ ìê·¹"; how=`<ul><li><strong>ì›Œë°ì—…:</strong> 10ë¶„ ì•„ì£¼ ì²œì²œíˆ ì¡°ê¹…</li><li><strong>ë³¸ìš´ë™ (6ì„¸íŠ¸):</strong><br> - 2ë¶„ ë¹ ë¥´ê²Œ (ëŒ€í™” ë¶ˆê°€ëŠ¥, ìˆ¨ì´ ì°¸)<br> - 3ë¶„ ëŠë¦¬ê²Œ (í˜¸í¡ ì •ë¦¬í•˜ë©° ì²œì²œíˆ ì¡°ê¹…)</li><li><strong>ì¿¨ë‹¤ìš´:</strong> 10ë¶„ ì•„ì£¼ ì²œì²œíˆ ì¡°ê¹…</li></ul>`; caution="ë¹ ë¥´ê²Œ ë‹¬ë¦´ ë•Œ ì „ë ¥ì§ˆì£¼(100%)ê°€ ì•„ë‹™ë‹ˆë‹¤. 80~90% í˜ìœ¼ë¡œ ë‹¬ë¦¬ì„¸ìš”."; }
                else if(d.type === 'Tempo') { d.title = "Threshold"; d.icon = "ğŸ”¥"; let dist = isFull? (week%2==0?'10km':'12km') : '8km'; desc = `í…œí¬ëŸ° ${dist} @ ${userPaces.threshold}`; tag = "Zone 4"; why="ì –ì‚° ì—­ì¹˜(ì§€ì¹˜ì§€ ì•ŠëŠ” í•œê³„ ì†ë„) í–¥ìƒ"; how=`<ul><li><strong>ì›Œë°ì—…:</strong> 3km ì¡°ê¹… + ì§§ì€ ì§ˆì£¼ 3íšŒ</li><li><strong>ë³¸ìš´ë™:</strong> ${dist}ë¥¼ <strong>${userPaces.threshold}</strong> í˜ì´ìŠ¤ë¡œ ê¾¸ì¤€íˆ ìœ ì§€í•©ë‹ˆë‹¤.<br>'í˜ë“¤ì§€ë§Œ 30ë¶„ì€ ë²„í‹¸ ìˆ˜ ìˆë‹¤'ëŠ” ëŠë‚Œì…ë‹ˆë‹¤.</li><li><strong>ì¿¨ë‹¤ìš´:</strong> 2km ì•„ì£¼ ëŠë¦° ì¡°ê¹…</li></ul>`; caution="í˜ì´ìŠ¤ê°€ ë“¤ì­‰ë‚ ì­‰í•˜ë©´ íš¨ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œê³„ë¥¼ ìì£¼ í™•ì¸í•˜ì„¸ìš”."; }
                else if(d.type === 'Interval') { d.title = "Interval"; d.icon = "âš¡"; desc = "1km ì¸í„°ë²Œ x 5íšŒ"; tag = "Zone 5"; why="ìµœëŒ€ ì‚°ì†Œ ì„­ì·¨ëŸ‰(VO2max) ê·¹ëŒ€í™” (ì—”ì§„ ì—…ê·¸ë ˆì´ë“œ)"; how=`<ul><li><strong>ì›Œë°ì—…:</strong> 3km ì¡°ê¹… + ìŠ¤íŠ¸ë ˆì¹­ ê¼¼ê¼¼íˆ</li><li><strong>ë³¸ìš´ë™ (5ì„¸íŠ¸):</strong><br> - 1km <strong>${userPaces.interval}</strong>ë¡œ ì§ˆì£¼ (ë§¤ìš° í˜ë“¦)<br> - 3ë¶„ê°„ ê±·ê±°ë‚˜ ì•„ì£¼ ëŠë¦¬ê²Œ ë›°ë©° íœ´ì‹</li><li><strong>ì¿¨ë‹¤ìš´:</strong> 3km ì•„ì£¼ ëŠë¦° ì¡°ê¹…</li></ul>`; caution="ëª©í‘œ í˜ì´ìŠ¤ë¥¼ ë‹¬ì„±í•˜ì§€ ëª»í•˜ë©´ íœ´ì‹ ì‹œê°„ì„ ëŠ˜ë¦¬ì„¸ìš”."; }
                else if(d.type === 'TaperPace') { d.title = "Marathon Pace"; d.icon = "ğŸ¯"; desc = `ëŒ€íšŒ í˜ì´ìŠ¤ ${isFull?'8km':'5km'} @ ${userPaces.marathon}`; tag = "Race Pace"; why="ëŒ€íšŒ ë‹¹ì¼ ê°ê° ìµíˆê¸° (í˜ì´ìŠ¤ ì¡°ì ˆ ì—°ìŠµ)"; how=`<ul><li><strong>ì›Œë°ì—…:</strong> 2km ì¡°ê¹…</li><li><strong>ë³¸ìš´ë™:</strong> ëª©í‘œ ëŒ€íšŒ í˜ì´ìŠ¤(<strong>${userPaces.marathon}</strong>)ë¡œ ì •í™•í•˜ê²Œ ë‹¬ë¦½ë‹ˆë‹¤.<br>ë„ˆë¬´ ë¹ ë¥´ì§€ë„, ëŠë¦¬ì§€ë„ ì•Šê²Œ ì œì–´í•˜ì„¸ìš”.</li><li><strong>ì¿¨ë‹¤ìš´:</strong> 1km ê±·ê¸°</li></ul>`; caution="ì»¨ë””ì…˜ì´ ì¢‹ë‹¤ê³  ë” ë¹¨ë¦¬, ë” ë§ì´ ë›°ë©´ ì•ˆ ë©ë‹ˆë‹¤."; }
                else if(d.type === 'Long') { let lDist = isFull ? (phase==='Base'?'20km':(phase==='Build'?'26km':(phase==='Peak'?'32km':'15km'))) : '15km'; desc = `LSD ${lDist}`; tag = "Endurance"; why="ì§€ë°©ì„ ì—ë„ˆì§€ë¡œ ì“°ëŠ” ëŠ¥ë ¥ ë°°ì–‘ & ì •ì‹ ë ¥ ê°•í™”"; how=`<ul><li><strong>ì¤€ë¹„ë¬¼:</strong> ë¬¼, ì—ë„ˆì§€ì ¤ 2~3ê°œ</li><li><strong>ë³¸ìš´ë™:</strong> <strong>${userPaces.easy}</strong> í˜ì´ìŠ¤ë¡œ ${lDist} ì™„ì£¼ê°€ ëª©í‘œì…ë‹ˆë‹¤.</li><li>ì†ë„ë³´ë‹¤ 'ë©ˆì¶”ì§€ ì•Šê³  ê³„ì† ë‹¬ë¦¬ëŠ” ê²ƒ'ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</li></ul>`; caution="ì¤‘ê°„ì— í˜ë“¤ë©´ ê±·ì§€ ë§ê³  ì•„ì£¼ ëŠë¦¬ê²Œ ë›°ì„¸ìš” (ì œìë¦¬ ë›°ê¸° ìˆ˜ì¤€ì´ë¼ë„ OK)."; }
                else if(d.type === 'Recovery') { desc = `íšŒë³µ ì¡°ê¹… 5km @ ${userPaces.recovery}`; tag = "Zone 1"; why="í˜ˆì•¡ ìˆœí™˜ì„ í†µí•´ ê·¼ìœ¡ í”¼ë¡œ ë¬¼ì§ˆ ì œê±°"; how=`<ul><li><strong>ë°©ë²•:</strong> <strong>${userPaces.recovery}</strong> í˜ì´ìŠ¤ë¡œ ì•„ì£¼ ê°€ë³ê²Œ ëœë‹ˆë‹¤.</li><li>ì˜† ì‚¬ëŒê³¼ ë…¸ë˜ë¥¼ ë¶€ë¥¼ ìˆ˜ ìˆì„ ì •ë„ë¡œ í¸í•´ì•¼ í•©ë‹ˆë‹¤.</li><li>ì ˆëŒ€ ìˆ¨ì´ ì°¨ë©´ ì•ˆ ë©ë‹ˆë‹¤.</li></ul>`; caution="ì´ í›ˆë ¨ì„ ë¹ ë¥´ê²Œ í•˜ë©´ ë¶€ìƒì´ ì˜µë‹ˆë‹¤. ëŠë¦¼ì˜ ë¯¸í•™ì„ ì¦ê¸°ì„¸ìš”."; }
                return { ...d, desc, tag, why, how, caution };
            });
        }
    </script>
</body>
</html>
